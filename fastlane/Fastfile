# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

podspecPath = "TestGithubCI.podspec"

platform :ios do
  desc "Pulls dependencies"
  lane :build_dependencies do
    cocoapods
  end

  desc "Generate Apple doc"
  lane :gen_apple_doc do
    appledoc(
      project_name: "TestGithubCI",
      project_company: "LinkedIn, Inc",
      input: [
        "TestStaticLib/*.swift"
      ],
      options: "--keep-intermediate-files --search-undocumented-doc",
      warnings: "--warn-missing-output-path --warn-missing-company-id"
    )
  end

  lane :lints do
    sh "pwd"
    subdirs = ["TestXCFramework", "TestXCFrameworkTests"]
    files = []
    Dir.chdir("..") do
      files = subdirs.map { |dir| Dir.glob("#{dir}/**/*.swift")}.flatten(1)
    end
    swiftlint(
      mode: :lint,
      files: files,
      executable: "Pods/SwiftLint/swiftlint"
    )
  end

  lane :tests do
    scan(
      scheme: "TestGithubCI",
      derived_data_path: "derived_data"
    )
    system "rm -r ../xcov_output/*"
    xcov(
      workspace: "TestGithubCI.xcworkspace",
      scheme: "TestGithubCI",
      output_directory: "xcov_output",
      skip_slack: true,
      derived_data_path: "derived_data"
    )
#    pod_lib_lint
  end

  desc "Push version to cocoapods"
  lane :push_cocoapods do
    newVersion = version_bump_podspec(
      path: podspecPath,
      bump_type: "patch"
    )
    git_commit(
      path: podspecPath,
      message: "Version bump"
    )
    push_to_git_remote
    add_git_tag(tag: newVersion)
    push_git_tags
    pod_push(allow_warnings: true)
  end
end


